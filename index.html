<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rover Cal">
    <link rel="manifest" href="manifest.json">
    <title>Rover Offset Calibration Calculator</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --card: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text: #eaeaea;
            --input-bg: #0f3460;
            --yellow: #f4d03f;
            --green: #2ecc71;
            --blue: #3498db;
            --orange: #e67e22;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0 auto;
            padding: 12px;
            padding-bottom: 100px;
            min-height: 100vh;
            max-width: 420px;
        }
        
        h1 {
            font-size: 1.3rem;
            text-align: center;
            margin: 0 0 4px 0;
            color: var(--highlight);
        }
        
        .subtitle {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 16px;
        }
        
        .instructions {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 3px solid var(--highlight);
        }
        
        .instructions p {
            margin: 0;
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.5;
        }
        
        .instructions strong {
            color: var(--yellow);
        }

        .section {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }
        
        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--yellow);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .input-grid.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group.full-width {
            grid-column: 1 / -1;
        }
        
        .input-group label {
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 4px;
        }
        
        .input-group input, .input-group select {
            background: var(--input-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--yellow);
        }
        
        .input-group input::placeholder {
            color: #666;
        }

        .input-group input[readonly] {
            background: #1a1a2e;
            color: #888;
        }

        .sample-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr 1fr 40px;
            gap: 6px;
            align-items: end;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .sample-row .sample-num {
            font-size: 0.8rem;
            color: var(--yellow);
            font-weight: 600;
            padding-bottom: 12px;
            min-width: 20px;
        }

        .sample-row input {
            background: var(--input-bg);
            border: 2px solid transparent;
            border-radius: 6px;
            padding: 10px 8px;
            color: var(--text);
            font-size: 0.9rem;
            width: 100%;
        }

        .sample-row input:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .sample-row .remove-btn {
            background: none;
            border: none;
            color: var(--highlight);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }

        .sample-header {
            display: grid;
            grid-template-columns: auto 1fr 1fr 1fr 40px;
            gap: 6px;
            padding: 0 8px;
            margin-bottom: 4px;
        }

        .sample-header span {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .add-btn {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px dashed #444;
            border-radius: 8px;
            background: transparent;
            color: #888;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 4px;
        }

        .add-btn:active {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-badge.good { background: rgba(46,204,113,0.2); color: var(--green); }
        .status-badge.warn { background: rgba(230,126,34,0.2); color: var(--orange); }
        .status-badge.bad { background: rgba(233,69,96,0.2); color: var(--highlight); }

        .results {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f3460 100%);
            border: 2px solid var(--green);
        }
        
        .results .section-title {
            color: var(--green);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .result-item {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }
        
        .result-item.full-width {
            grid-column: 1 / -1;
        }
        
        .result-label {
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 6px;
        }
        
        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--green);
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        
        .result-unit {
            font-size: 0.8rem;
            color: #888;
            margin-left: 4px;
        }

        .result-sub {
            font-size: 0.7rem;
            color: #888;
            margin-top: 4px;
        }

        .copy-btn {
            display: block;
            width: 100%;
            margin-top: 14px;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: var(--green);
            color: #000;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .copy-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        .clear-btn {
            width: 100%;
            margin-bottom: 12px;
            padding: 10px 8px;
            border: none;
            border-radius: 8px;
            background: var(--highlight);
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:active {
            transform: scale(0.97);
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--green);
            color: #000;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .collapsible-header .toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 800px;
        }

        .collapsed .toggle {
            transform: rotate(-90deg);
        }

        .divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 12px 0;
        }

        .info-text {
            font-size: 0.8rem;
            color: #888;
            line-height: 1.4;
            margin: 0;
        }

        .per-sample-results {
            margin-top: 12px;
        }

        .per-sample-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr 1fr 1fr;
            gap: 6px;
            padding: 6px 8px;
            font-size: 0.75rem;
            font-family: 'SF Mono', 'Menlo', monospace;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .per-sample-row.header {
            color: #888;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .per-sample-row .num { color: var(--yellow); min-width: 20px; }
        .per-sample-row .val { color: var(--text); text-align: right; }
        .per-sample-row .outlier { color: var(--highlight); }
    </style>
</head>
<body>
    <h1>üì° Rover Offset Calibration</h1>
    <p class="subtitle">Third-Rover Method ‚Äî No Ground Targets Required</p>
    
    <div class="instructions">
        <p><strong>Step 1:</strong> Mount survey rover at known offset from work point<br>
        <strong>Step 2:</strong> Enter the mechanical offset of the rover from work point<br>
        <strong>Step 3:</strong> Collect simultaneous readings ‚Äî machine antenna + rover position<br>
        <strong>Step 4:</strong> Enter machine heading from dual-antenna for each sample<br>
        <strong>Minimum:</strong> 3 samples required, 10+ recommended</p>
    </div>

    <div class="section">
        <div class="section-title">üìê Rover Mechanical Offset from Work Point</div>
        <p class="info-text" style="margin-bottom: 12px;">Known fixed offset of the calibration rover from the machine work point (tip). Measured along machine body axes.</p>
        <div class="input-grid three-col">
            <div class="input-group">
                <label>X (forward) ft</label>
                <input type="number" id="mechX" step="any" placeholder="5.000" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>Y (right) ft</label>
                <input type="number" id="mechY" step="any" placeholder="0.000" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>Z (down) ft</label>
                <input type="number" id="mechZ" step="any" placeholder="0.000" oninput="calculate()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">üì° Current Machine Antenna Offsets</div>
        <p class="info-text" style="margin-bottom: 12px;">Enter current offsets programmed in the machine (what we're verifying/refining).</p>
        <div class="input-grid">
            <div class="input-group full-width">
                <label>Current Heading Offset (¬∞)</label>
                <input type="number" id="curHeadingOffset" step="any" placeholder="-89.2" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>Current X (forward) ft</label>
                <input type="number" id="curX" step="any" placeholder="3.586" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>Current Y (right) ft</label>
                <input type="number" id="curY" step="any" placeholder="4.478" oninput="calculate()">
            </div>
            <div class="input-group full-width">
                <label>Current Z (down) ft</label>
                <input type="number" id="curZ" step="any" placeholder="-6.737" oninput="calculate()">
            </div>
        </div>
    </div>

    <button class="clear-btn" onclick="clearSamples()">Clear All Samples</button>

    <div class="section">
        <div class="section-title">üìä Sample Data <span id="sampleCount" class="status-badge warn">0 samples</span></div>
        <p class="info-text" style="margin-bottom: 12px;">For each sample: record machine antenna position (AH=0), rover position, and machine heading from dual-antenna. Collect with machine at different headings for best results.</p>
        
        <div class="sample-header">
            <span>#</span>
            <span>Mach N (ft)</span>
            <span>Mach E (ft)</span>
            <span>Mach Z (ft)</span>
            <span></span>
        </div>
        <div class="sample-header" style="margin-top: -4px;">
            <span></span>
            <span>Rover N (ft)</span>
            <span>Rover E (ft)</span>
            <span>Rover Z (ft)</span>
            <span></span>
        </div>
        <div class="sample-header" style="margin-top: -4px; margin-bottom: 8px;">
            <span></span>
            <span>Heading (¬∞)</span>
            <span>Pitch (¬∞)</span>
            <span>Roll (¬∞)</span>
            <span></span>
        </div>

        <div id="samplesContainer"></div>
        
        <button class="add-btn" onclick="addSample()">+ Add Sample</button>
    </div>

    <div class="section results" id="resultsSection">
        <div class="section-title">‚úÖ Refined Antenna Offsets</div>
        <p class="info-text" style="margin-bottom: 12px;">Computed corrections based on comparing the rover-derived work point against the machine-reported work point. Shows the <strong style="color: var(--yellow);">adjustment (Œî)</strong> to apply to your current offsets and the <strong style="color: var(--green);">new absolute values</strong>.</p>
        
        <div class="input-group" style="margin-bottom: 12px;">
            <label>Machine ID</label>
            <input type="text" id="machineId" placeholder="Enter machine ID">
        </div>
        
        <div class="result-grid">
            <div class="result-item full-width">
                <div class="result-label">Heading Correction</div>
                <div class="result-value"><span id="resultHeading">--</span><span class="result-unit">¬∞</span></div>
                <div class="result-sub">New: <span id="newHeading">--</span>¬∞</div>
            </div>
            <div class="result-item">
                <div class="result-label">ŒîX (forward)</div>
                <div class="result-value"><span id="resultX">--</span><span class="result-unit">ft</span></div>
                <div class="result-sub">New: <span id="newX">--</span> ft</div>
            </div>
            <div class="result-item">
                <div class="result-label">ŒîY (right)</div>
                <div class="result-value"><span id="resultY">--</span><span class="result-unit">ft</span></div>
                <div class="result-sub">New: <span id="newY">--</span> ft</div>
            </div>
            <div class="result-item full-width">
                <div class="result-label">ŒîZ (down)</div>
                <div class="result-value"><span id="resultZ">--</span><span class="result-unit">ft</span></div>
                <div class="result-sub">New: <span id="newZ">--</span> ft</div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="result-grid">
            <div class="result-item">
                <div class="result-label">RMS Error</div>
                <div class="result-value"><span id="resultRMS">--</span><span class="result-unit">ft</span></div>
            </div>
            <div class="result-item">
                <div class="result-label">Max Residual</div>
                <div class="result-value"><span id="resultMaxRes">--</span><span class="result-unit">ft</span></div>
            </div>
            <div class="result-item full-width">
                <div class="result-label">Confidence</div>
                <div class="result-value"><span id="resultConfidence">--</span></div>
            </div>
        </div>

        <button class="copy-btn" onclick="copyResults()">üìã Copy Results</button>
    </div>

    <div class="section collapsed" id="debugSection">
        <div class="collapsible-header" onclick="toggleDebug()">
            <div class="section-title" style="margin-bottom:0">üîç Per-Sample Residuals</div>
            <span class="toggle">‚ñº</span>
        </div>
        <div class="collapsible-content" id="debugContent">
            <div class="per-sample-results" id="perSampleResults">
                <div class="per-sample-row header">
                    <span>#</span>
                    <span>ŒîX err</span>
                    <span>ŒîY err</span>
                    <span>ŒîZ err</span>
                    <span>Total</span>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Copied to clipboard!</div>

    <script>
        let sampleCount = 0;

        function addSample() {
            sampleCount++;
            const container = document.getElementById('samplesContainer');
            const div = document.createElement('div');
            div.id = `sample-${sampleCount}`;
            div.className = 'sample-block';
            div.style.marginBottom = '12px';
            div.style.borderLeft = '2px solid var(--accent)';
            div.style.paddingLeft = '4px';
            
            const n = sampleCount;
            div.innerHTML = `
                <div class="sample-row">
                    <div class="sample-num">${n}</div>
                    <input type="number" step="any" placeholder="Mach N" id="s${n}_machN" oninput="calculate()">
                    <input type="number" step="any" placeholder="Mach E" id="s${n}_machE" oninput="calculate()">
                    <input type="number" step="any" placeholder="Mach Z" id="s${n}_machZ" oninput="calculate()">
                    <button class="remove-btn" onclick="removeSample(${n})">‚úï</button>
                </div>
                <div class="sample-row" style="margin-top:-4px;">
                    <div class="sample-num"></div>
                    <input type="number" step="any" placeholder="Rover N" id="s${n}_roverN" oninput="calculate()">
                    <input type="number" step="any" placeholder="Rover E" id="s${n}_roverE" oninput="calculate()">
                    <input type="number" step="any" placeholder="Rover Z" id="s${n}_roverZ" oninput="calculate()">
                    <div></div>
                </div>
                <div class="sample-row" style="margin-top:-4px;">
                    <div class="sample-num"></div>
                    <input type="number" step="any" placeholder="Heading¬∞" id="s${n}_heading" oninput="calculate()">
                    <input type="number" step="any" placeholder="Pitch¬∞" id="s${n}_pitch" value="0" oninput="calculate()">
                    <input type="number" step="any" placeholder="Roll¬∞" id="s${n}_roll" value="0" oninput="calculate()">
                    <div></div>
                </div>
            `;
            container.appendChild(div);
            updateSampleCount();
            calculate();
        }

        function removeSample(n) {
            const el = document.getElementById(`sample-${n}`);
            if (el) el.remove();
            updateSampleCount();
            calculate();
        }

        function clearSamples() {
            document.getElementById('samplesContainer').innerHTML = '';
            sampleCount = 0;
            updateSampleCount();
            calculate();
        }

        function updateSampleCount() {
            const blocks = document.querySelectorAll('.sample-block');
            const count = blocks.length;
            const badge = document.getElementById('sampleCount');
            badge.textContent = `${count} sample${count !== 1 ? 's' : ''}`;
            if (count >= 10) {
                badge.className = 'status-badge good';
            } else if (count >= 3) {
                badge.className = 'status-badge warn';
            } else {
                badge.className = 'status-badge bad';
            }
        }

        function getVal(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            const v = parseFloat(el.value);
            return isNaN(v) ? null : v;
        }

        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }

        // Rotate a vector from body frame to world frame given heading, pitch, roll
        function bodyToWorld(x, y, z, heading, pitch, roll) {
            const h = toRad(heading);
            const p = toRad(pitch);
            const r = toRad(roll);
            
            const cosH = Math.cos(h), sinH = Math.sin(h);
            const cosP = Math.cos(p), sinP = Math.sin(p);
            const cosR = Math.cos(r), sinR = Math.sin(r);
            
            // Rotation matrix: R_heading * R_pitch * R_roll
            // World N = x*cosH*cosP + y*(cosH*sinP*sinR - sinH*cosR) + z*(cosH*sinP*cosR + sinH*sinR)
            // World E = x*sinH*cosP + y*(sinH*sinP*sinR + cosH*cosR) + z*(sinH*sinP*cosR - cosH*sinR)
            // World D = x*(-sinP)   + y*(cosP*sinR)                  + z*(cosP*cosR)
            
            const wN = x * cosH * cosP + y * (cosH * sinP * sinR - sinH * cosR) + z * (cosH * sinP * cosR + sinH * sinR);
            const wE = x * sinH * cosP + y * (sinH * sinP * sinR + cosH * cosR) + z * (sinH * sinP * cosR - cosH * sinR);
            const wD = x * (-sinP) + y * (cosP * sinR) + z * (cosP * cosR);
            
            return { n: wN, e: wE, d: wD };
        }

        // Rotate a vector from world frame to body frame (inverse rotation)
        function worldToBody(dN, dE, dD, heading, pitch, roll) {
            const h = toRad(heading);
            const p = toRad(pitch);
            const r = toRad(roll);
            
            const cosH = Math.cos(h), sinH = Math.sin(h);
            const cosP = Math.cos(p), sinP = Math.sin(p);
            const cosR = Math.cos(r), sinR = Math.sin(r);
            
            // Transpose of the bodyToWorld matrix
            const x = dN * cosH * cosP + dE * sinH * cosP + dD * (-sinP);
            const y = dN * (cosH * sinP * sinR - sinH * cosR) + dE * (sinH * sinP * sinR + cosH * cosR) + dD * (cosP * sinR);
            const z = dN * (cosH * sinP * cosR + sinH * sinR) + dE * (sinH * sinP * cosR - cosH * sinR) + dD * (cosP * cosR);
            
            return { x, y, z };
        }

        function calculate() {
            // Get mechanical offset
            const mechX = getVal('mechX');
            const mechY = getVal('mechY');
            const mechZ = getVal('mechZ');
            
            // Get current offsets
            const curHO = getVal('curHeadingOffset');
            const curX = getVal('curX');
            const curY = getVal('curY');
            const curZ = getVal('curZ');
            
            if ([mechX, mechY, mechZ, curHO, curX, curY, curZ].some(v => v === null)) {
                clearResults();
                return;
            }

            // Collect valid samples
            const samples = [];
            const blocks = document.querySelectorAll('.sample-block');
            blocks.forEach(block => {
                const id = block.id.replace('sample-', '');
                const machN = getVal(`s${id}_machN`);
                const machE = getVal(`s${id}_machE`);
                const machZ = getVal(`s${id}_machZ`);
                const roverN = getVal(`s${id}_roverN`);
                const roverE = getVal(`s${id}_roverE`);
                const roverZ = getVal(`s${id}_roverZ`);
                const heading = getVal(`s${id}_heading`);
                const pitch = getVal(`s${id}_pitch`);
                const roll = getVal(`s${id}_roll`);
                
                if ([machN, machE, machZ, roverN, roverE, roverZ, heading, pitch, roll].every(v => v !== null)) {
                    samples.push({ id, machN, machE, machZ, roverN, roverE, roverZ, heading, pitch: pitch || 0, roll: roll || 0 });
                }
            });

            if (samples.length < 3) {
                clearResults();
                return;
            }

            // For each sample, compute the offset error
            // 1. From rover position + mechanical offset + heading ‚Üí compute true work point
            // 2. From machine antenna position + current offsets + heading ‚Üí compute reported work point
            // 3. Difference = offset error in world frame ‚Üí transform to body frame

            const errors = [];

            for (const s of samples) {
                // True work point from rover:
                // Rover is at known mechanical offset from work point
                // So work point = rover position - rotated mechanical offset
                const mechWorld = bodyToWorld(mechX, mechY, mechZ, s.heading, s.pitch, s.roll);
                const trueWP_N = s.roverN - mechWorld.n;
                const trueWP_E = s.roverE - mechWorld.e;
                const trueWP_D = s.roverZ - mechWorld.d;

                // Reported work point from machine antenna + current offsets:
                const curWorld = bodyToWorld(curX, curY, curZ, s.heading + curHO, s.pitch, s.roll);
                const reportedWP_N = s.machN + curWorld.n;
                const reportedWP_E = s.machE + curWorld.e;
                const reportedWP_D = s.machZ + curWorld.d;

                // Error in world frame
                const errN = trueWP_N - reportedWP_N;
                const errE = trueWP_E - reportedWP_E;
                const errD = trueWP_D - reportedWP_D;

                // Transform error to body frame for this heading
                const bodyErr = worldToBody(errN, errE, errD, s.heading + curHO, s.pitch, s.roll);

                errors.push({
                    id: s.id,
                    errN, errE, errD,
                    errX: bodyErr.x,
                    errY: bodyErr.y,
                    errZ: bodyErr.z,
                    total: Math.sqrt(errN * errN + errE * errE + errD * errD)
                });
            }

            // Average the body-frame errors = correction to apply
            const n = errors.length;
            const avgX = errors.reduce((s, e) => s + e.errX, 0) / n;
            const avgY = errors.reduce((s, e) => s + e.errY, 0) / n;
            const avgZ = errors.reduce((s, e) => s + e.errZ, 0) / n;

            // Heading correction: compute from average world-frame error
            const avgN = errors.reduce((s, e) => s + e.errN, 0) / n;
            const avgE = errors.reduce((s, e) => s + e.errE, 0) / n;
            // Heading error = atan2 of cross-track error at distance
            // Simpler: compute heading correction from the X/Y error pattern
            const headingCorr = toDeg(Math.atan2(avgY, Math.abs(curX) || 1));

            // Residuals after correction
            const residuals = errors.map(e => {
                const rx = e.errX - avgX;
                const ry = e.errY - avgY;
                const rz = e.errZ - avgZ;
                return Math.sqrt(rx * rx + ry * ry + rz * rz);
            });

            const rms = Math.sqrt(residuals.reduce((s, r) => s + r * r, 0) / n);
            const maxRes = Math.max(...residuals);

            // New absolute offsets
            const newX = curX + avgX;
            const newY = curY + avgY;
            const newZ = curZ + avgZ;
            const newHO = curHO + headingCorr;

            // Confidence
            let confidence, confClass;
            if (rms < 0.02 && n >= 10) {
                confidence = 'HIGH';
                confClass = 'good';
            } else if (rms < 0.05 && n >= 5) {
                confidence = 'MEDIUM';
                confClass = 'warn';
            } else {
                confidence = 'LOW';
                confClass = 'bad';
            }

            // Display results
            document.getElementById('resultHeading').textContent = headingCorr.toFixed(3);
            document.getElementById('resultX').textContent = avgX.toFixed(4);
            document.getElementById('resultY').textContent = avgY.toFixed(4);
            document.getElementById('resultZ').textContent = avgZ.toFixed(4);
            document.getElementById('newHeading').textContent = newHO.toFixed(3);
            document.getElementById('newX').textContent = newX.toFixed(4);
            document.getElementById('newY').textContent = newY.toFixed(4);
            document.getElementById('newZ').textContent = newZ.toFixed(4);
            document.getElementById('resultRMS').textContent = rms.toFixed(4);
            document.getElementById('resultMaxRes').textContent = maxRes.toFixed(4);
            
            const confEl = document.getElementById('resultConfidence');
            confEl.textContent = confidence + ` (n=${n})`;
            confEl.style.color = confClass === 'good' ? 'var(--green)' : confClass === 'warn' ? 'var(--orange)' : 'var(--highlight)';

            // Per-sample debug
            const debugContainer = document.getElementById('perSampleResults');
            debugContainer.innerHTML = `
                <div class="per-sample-row header">
                    <span>#</span>
                    <span style="text-align:right">ŒîX err</span>
                    <span style="text-align:right">ŒîY err</span>
                    <span style="text-align:right">ŒîZ err</span>
                    <span style="text-align:right">Total</span>
                </div>
            `;
            
            // Flag outliers (>2œÉ)
            const mean = residuals.reduce((s, r) => s + r, 0) / n;
            const stdDev = Math.sqrt(residuals.reduce((s, r) => s + (r - mean) ** 2, 0) / n);
            
            errors.forEach((e, i) => {
                const isOutlier = residuals[i] > mean + 2 * stdDev;
                const cls = isOutlier ? 'outlier' : '';
                debugContainer.innerHTML += `
                    <div class="per-sample-row">
                        <span class="num">${e.id}</span>
                        <span class="val ${cls}">${e.errX.toFixed(4)}</span>
                        <span class="val ${cls}">${e.errY.toFixed(4)}</span>
                        <span class="val ${cls}">${e.errZ.toFixed(4)}</span>
                        <span class="val ${cls}">${e.total.toFixed(4)}</span>
                    </div>
                `;
            });
        }

        function clearResults() {
            ['resultHeading', 'resultX', 'resultY', 'resultZ', 'newHeading', 'newX', 'newY', 'newZ', 'resultRMS', 'resultMaxRes'].forEach(id => {
                document.getElementById(id).textContent = '--';
            });
            document.getElementById('resultConfidence').textContent = '--';
        }

        function copyResults() {
            const machineId = document.getElementById('machineId').value || 'N/A';
            const h = document.getElementById('resultHeading').textContent;
            const x = document.getElementById('resultX').textContent;
            const y = document.getElementById('resultY').textContent;
            const z = document.getElementById('resultZ').textContent;
            const nh = document.getElementById('newHeading').textContent;
            const nx = document.getElementById('newX').textContent;
            const ny = document.getElementById('newY').textContent;
            const nz = document.getElementById('newZ').textContent;
            const rms = document.getElementById('resultRMS').textContent;
            const conf = document.getElementById('resultConfidence').textContent;
            
            if (h === '--') {
                showToast('No results to copy');
                return;
            }
            
            const text = [
                `Rover Calibration Results`,
                `Machine: ${machineId}`,
                `Date: ${new Date().toLocaleDateString()}`,
                ``,
                `Corrections:`,
                `  Heading: ${h}¬∞`,
                `  ŒîX: ${x} ft`,
                `  ŒîY: ${y} ft`,
                `  ŒîZ: ${z} ft`,
                ``,
                `New Offsets:`,
                `  Heading: ${nh}¬∞`,
                `  X: ${nx} ft`,
                `  Y: ${ny} ft`,
                `  Z: ${nz} ft`,
                ``,
                `RMS: ${rms} ft | Confidence: ${conf}`
            ].join('\n');
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied to clipboard!');
                }).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.setAttribute('readonly', '');
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!');
            } catch (err) {
                prompt('Copy these values:', text);
            }
            document.body.removeChild(textarea);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function toggleDebug() {
            const section = document.getElementById('debugSection');
            const content = document.getElementById('debugContent');
            section.classList.toggle('collapsed');
            content.classList.toggle('open');
        }

        // Start with 3 sample rows
        addSample();
        addSample();
        addSample();
    </script>
</body>
</html>
